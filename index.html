<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CHAT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#000,#1a0033,#000);
  color:#fff;
}
.container{
  max-width:420px;
  margin:40px auto;
  background:rgba(0,0,0,.9);
  padding:20px;
  border-radius:16px;
  box-shadow:0 0 25px #ff00ff;
}
h2{text-align:center;color:#ff00ff}
button,input,select{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:8px;
}
button{
  background:linear-gradient(90deg,#ff00ff,#ff0066);
  color:#fff;
  font-weight:bold;
}
input,select{
  background:#111;
  color:#fff;
  border:1px solid #333;
}
#chat{display:none}
#mensajes{
  height:260px;
  overflow-y:auto;
  background:#000;
  border:1px solid #333;
  padding:10px;
  margin-bottom:8px;
}
.msg{margin-bottom:6px}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged,
  signOut,
  updateProfile
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  collection,
  addDoc,
  query,
  orderBy,
  onSnapshot,
  serverTimestamp,
  increment
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ğŸ”¥ TU FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyBszwdqJLY0GiPNlxh37_wNpSsIm0y9N0c",
  authDomain: "chat-1adf8.firebaseapp.com",
  projectId: "chat-1adf8",
  storageBucket: "chat-1adf8.firebasestorage.app",
  messagingSenderId: "466107819820",
  appId: "1:466107819820:web:e297a7c513db3d96696e89"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let userData = null;

/* LOGIN GOOGLE */
window.loginGoogle = async()=>{
  await signInWithPopup(auth,provider);
};

/* SESIÃ“N */
onAuthStateChanged(auth, async(user)=>{
  if(!user) return;

  const ref = doc(db,"usuarios",user.uid);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    document.getElementById("login").style.display="none";
    document.getElementById("setup").style.display="block";
  }else{
    userData = snap.data();
    entrarChat();
  }
});

/* GUARDAR PERFIL */
window.guardarPerfil = async()=>{
  const nick = nickInput.value;
  const genero = generoSelect.value;
  if(!nick || !genero) return alert("Completa todo");

  const monedas = genero==="hombre"?500:0;

  await setDoc(doc(db,"usuarios",auth.currentUser.uid),{
    nick,
    genero,
    monedas,
    ganancias:0
  });

  await updateProfile(auth.currentUser,{displayName:nick});
  location.reload();
};

/* ENTRAR AL CHAT */
function entrarChat(){
  document.getElementById("login").style.display="none";
  document.getElementById("setup").style.display="none";
  document.getElementById("chat").style.display="block";

  usuario.innerText = userData.nick+" ("+userData.genero+")";
  monedasEl.innerText = userData.monedas;

  escucharChat();
}

/* ENVIAR MENSAJE */
window.enviarMensaje = async()=>{
  if(!texto.value) return;

  await addDoc(collection(db,"chat"),{
    nick:userData.nick,
    genero:userData.genero,
    texto:texto.value,
    tipo:"texto",
    time:serverTimestamp()
  });
  texto.value="";
};

/* ESCUCHAR CHAT */
function escucharChat(){
  const q = query(collection(db,"chat"),orderBy("time"));
  onSnapshot(q,snap=>{
    mensajes.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg";

      if(m.tipo==="regalo") div.style.color="#FFD700";
      else if(m.genero==="mujer") div.style.color="#ff4fd8";
      else div.style.color="#4fc3ff";

      div.innerText = m.nick+": "+m.texto;
      mensajes.appendChild(div);
    });
    mensajes.scrollTop = mensajes.scrollHeight;
  });
}

/* REGALO */
window.enviarRegalo = async(nombre,precio)=>{
  if(userData.monedas < precio) return alert("No tienes monedas");

  await updateDoc(doc(db,"usuarios",auth.currentUser.uid),{
    monedas:increment(-precio)
  });

  await addDoc(collection(db,"chat"),{
    nick:userData.nick,
    texto:`ğŸ ${nombre} (${precio})`,
    tipo:"regalo",
    time:serverTimestamp()
  });

  userData.monedas -= precio;
  monedasEl.innerText = userData.monedas;
};

/* SALIR */
window.salir = async()=>{
  await signOut(auth);
  location.reload();
};
</script>
</head>

<body>

<div class="container" id="login">
  <h2>ğŸ”¥ CHAT ğŸ”¥</h2>
  <button onclick="loginGoogle()">Entrar con Google</button>
</div>

<div class="container" id="setup" style="display:none">
  <h2>Configura tu perfil</h2>
  <input id="nickInput" placeholder="Tu nick">
  <select id="generoSelect">
    <option value="">Selecciona gÃ©nero</option>
    <option value="hombre">Hombre</option>
    <option value="mujer">Mujer</option>
  </select>
  <button onclick="guardarPerfil()">Guardar</button>
</div>

<div class="container" id="chat">
  ğŸ‘¤ <span id="usuario"></span><br>
  ğŸ’° Monedas: <span id="monedasEl">0</span><br><br>

  <div id="mensajes"></div>

  <input id="texto" placeholder="Mensaje">
  <button onclick="enviarMensaje()">Enviar</button>

  <hr>
  <button onclick="enviarRegalo('Rosa',50)">ğŸŒ¹ Rosa (50)</button>
  <button onclick="enviarRegalo('Copa',100)">ğŸ· Copa (100)</button>
  <button onclick="enviarRegalo('Diamante',300)">ğŸ’ Diamante (300)</button>

  <br><br>
  <button onclick="salir()">Salir</button>
</div>

</body>
</html>
