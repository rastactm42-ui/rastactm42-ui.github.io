<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHAT</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#000;color:#fff;height:100vh;overflow:hidden}

#login{
  height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:15px;
}
#login button{
  padding:14px 25px;
  font-size:16px;
  border:none;
  border-radius:8px;
  background:#ff0066;
  color:#fff;
}

#app{display:none;flex-direction:column;height:100vh}

header{text-align:center;padding:14px;font-size:20px;border-bottom:1px solid #222}

section{flex:1;display:none;justify-content:center;align-items:center}

nav{
  height:60px;
  display:flex;
  justify-content:space-around;
  align-items:center;
  border-top:1px solid #222;
}
nav button{
  background:none;border:none;color:#888;font-size:14px
}
nav button.active{color:#ff0066;font-weight:bold}

/* CARD */
.card{
  width:90%;
  max-width:400px;
  height:80vh;
  border-radius:20px;
  overflow:hidden;
  position:relative;
  box-shadow:0 0 25px rgba(255,0,120,.4);
}
.card img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.info{
  position:absolute;
  bottom:0;
  width:100%;
  padding:20px;
  background:linear-gradient(transparent,rgba(0,0,0,.9));
}
.actions{
  position:absolute;
  bottom:-70px;
  width:100%;
  display:flex;
  justify-content:space-around;
}
.actions button{
  width:65px;height:65px;border-radius:50%;
  border:none;font-size:26px;color:#fff;
}
.nope{background:#333}
.like{background:#ff0066}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  collection,
  getDocs,
  addDoc,
  query,
  where
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig={
  apiKey:"AIzaSyBszwdqJLY0GiPNlxh37_wNpSsIm0y9N0c",
  authDomain:"chat-1adf8.firebaseapp.com",
  projectId:"chat-1adf8",
  storageBucket:"chat-1adf8.appspot.com",
  messagingSenderId:"466107819820",
  appId:"1:466107819820:web:e297a7c513db3d96696e89"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const provider=new GoogleAuthProvider();

let usuarios=[];
let index=0;
let actual=null;

/* LOGIN */
window.loginGoogle=async()=>{
  await signInWithPopup(auth,provider);
};

/* SESI√ìN */
onAuthStateChanged(auth,async user=>{
  if(!user) return;
  document.getElementById("login").style.display="none";
  document.getElementById("app").style.display="flex";
  abrir("descubrir");

  const ref=doc(db,"usuarios",user.uid);
  if(!(await getDoc(ref)).exists()){
    await setDoc(ref,{
      uid:user.uid,
      nick:user.displayName,
      foto:user.photoURL
    });
  }

  cargarUsuarios();
});

/* CARGAR USUARIOS */
async function cargarUsuarios(){
  usuarios=[];
  const snap=await getDocs(collection(db,"usuarios"));
  snap.forEach(d=>{
    if(d.id!==auth.currentUser.uid){
      usuarios.push(d.data());
    }
  });
  mostrar();
}

function mostrar(){
  if(usuarios.length===0) return;
  actual=usuarios[index];
  document.getElementById("foto").src=actual.foto;
  document.getElementById("nombre").innerText=actual.nick;
}

/* LIKE / DISLIKE */
window.like=async()=>{
  await addDoc(collection(db,"likes"),{
    from:auth.currentUser.uid,
    to:actual.uid
  });

  const q=query(
    collection(db,"likes"),
    where("from","==",actual.uid),
    where("to","==",auth.currentUser.uid)
  );
  const snap=await getDocs(q);
  if(!snap.empty){
    alert("üî• MATCH con "+actual.nick);
    await addDoc(collection(db,"matches"),{
      a:auth.currentUser.uid,
      b:actual.uid
    });
  }
  siguiente();
};

window.dislike=()=>{
  siguiente();
};

function siguiente(){
  index++;
  if(index>=usuarios.length) index=0;
  mostrar();
}

/* NAVEGACI√ìN */
window.abrir=(id)=>{
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="flex";
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn-"+id).classList.add("active");
};
</script>
</head>

<body>

<div id="login">
  <h2>CHAT</h2>
  <button onclick="loginGoogle()">Entrar con Google</button>
</div>

<div id="app">

<header>DESCUBRIR</header>

<section id="descubrir">
  <div class="card">
    <img id="foto">
    <div class="info">
      <h2 id="nombre"></h2>
    </div>
    <div class="actions">
      <button class="nope" onclick="dislike()">‚ùå</button>
      <button class="like" onclick="like()">‚ù§Ô∏è</button>
    </div>
  </div>
</section>

<section id="chat"><h3>Chat (PASO 4)</h3></section>
<section id="perfil"><h3>Perfil (ya hecho)</h3></section>
<section id="config"><h3>Config</h3></section>

<nav>
  <button id="btn-descubrir" class="active" onclick="abrir('descubrir')">Descubrir</button>
  <button id="btn-chat" onclick="abrir('chat')">Chat</button>
  <button id="btn-perfil" onclick="abrir('perfil')">Perfil</button>
  <button id="btn-config" onclick="abrir('config')">Config</button>
</nav>

</div>

</body>
</html>
