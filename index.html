<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHAT</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#000;color:#fff;height:100vh;overflow:hidden}

#login{
  height:100vh;display:flex;flex-direction:column;
  justify-content:center;align-items:center;gap:15px
}
#login button{
  padding:14px 25px;font-size:16px;border:none;
  border-radius:8px;background:#ff0066;color:#fff
}

#app{display:none;flex-direction:column;height:100vh}

header{text-align:center;padding:14px;font-size:20px;border-bottom:1px solid #222}

section{flex:1;display:none}

nav{
  height:60px;display:flex;justify-content:space-around;
  align-items:center;border-top:1px solid #222
}
nav button{
  background:none;border:none;color:#888;font-size:14px
}
nav button.active{color:#ff0066;font-weight:bold}

/* DESCUBRIR */
.card{
  width:90%;max-width:400px;height:80vh;
  margin:auto;border-radius:20px;overflow:hidden;
  position:relative;box-shadow:0 0 25px rgba(255,0,120,.4)
}
.card img{width:100%;height:100%;object-fit:cover}
.info{
  position:absolute;bottom:0;width:100%;padding:20px;
  background:linear-gradient(transparent,rgba(0,0,0,.9))
}
.actions{
  position:absolute;bottom:-70px;width:100%;
  display:flex;justify-content:space-around
}
.actions button{
  width:65px;height:65px;border-radius:50%;
  border:none;font-size:26px;color:#fff
}
.nope{background:#333}
.like{background:#ff0066}

/* MATCH LIST */
.list{
  padding:15px
}
.user{
  display:flex;align-items:center;gap:10px;
  padding:10px;border-bottom:1px solid #222;
  cursor:pointer
}
.user img{
  width:45px;height:45px;border-radius:50%;object-fit:cover
}

/* CHAT */
#mensajes{
  height:calc(100vh - 170px);
  overflow-y:auto;padding:10px
}
.msg{margin:6px 0}
.me{color:#ff0066}
.other{color:#fff}
#chatInput{
  display:flex;border-top:1px solid #222
}
#chatInput input{
  flex:1;padding:12px;background:#000;border:none;color:#fff
}
#chatInput button{
  padding:12px 18px;background:#ff0066;border:none;color:#fff
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig={
  apiKey:"AIzaSyBszwdqJLY0GiPNlxh37_wNpSsIm0y9N0c",
  authDomain:"chat-1adf8.firebaseapp.com",
  projectId:"chat-1adf8",
  storageBucket:"chat-1adf8.appspot.com",
  messagingSenderId:"466107819820",
  appId:"1:466107819820:web:e297a7c513db3d96696e89"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const provider=new GoogleAuthProvider();

let usuarios=[],index=0,actual=null,chatCon=null;

/* LOGIN */
window.loginGoogle=()=>signInWithPopup(auth,provider);

/* SESI√ìN */
onAuthStateChanged(auth,async user=>{
  if(!user) return;
  login.style.display="none";
  appDiv.style.display="flex";
  abrir("descubrir");

  const ref=doc(db,"usuarios",user.uid);
  if(!(await getDoc(ref)).exists()){
    await setDoc(ref,{uid:user.uid,nick:user.displayName,foto:user.photoURL});
  }
  cargarUsuarios();
  cargarMatches();
});

/* DESCUBRIR */
async function cargarUsuarios(){
  usuarios=[];
  const snap=await getDocs(collection(db,"usuarios"));
  snap.forEach(d=>{
    if(d.id!==auth.currentUser.uid) usuarios.push(d.data());
  });
  mostrar();
}
function mostrar(){
  if(!usuarios.length) return;
  actual=usuarios[index];
  foto.src=actual.foto;
  nombre.innerText=actual.nick;
}
window.like=async()=>{
  await addDoc(collection(db,"likes"),{from:auth.currentUser.uid,to:actual.uid});
  const q=query(collection(db,"likes"),
    where("from","==",actual.uid),
    where("to","==",auth.currentUser.uid));
  const s=await getDocs(q);
  if(!s.empty){
    await addDoc(collection(db,"matches"),{a:auth.currentUser.uid,b:actual.uid});
    alert("üî• MATCH");
    cargarMatches();
  }
  index=(index+1)%usuarios.length;mostrar();
};
window.dislike=()=>{index=(index+1)%usuarios.length;mostrar();};

/* MATCHES */
async function cargarMatches(){
  matches.innerHTML="";
  const uid=auth.currentUser.uid;
  const q=query(collection(db,"matches"),
    where("a","==",uid));
  const q2=query(collection(db,"matches"),
    where("b","==",uid));
  const [s1,s2]=await Promise.all([getDocs(q),getDocs(q2)]);
  const ids=[];
  s1.forEach(d=>ids.push(d.data().b));
  s2.forEach(d=>ids.push(d.data().a));
  for(const id of ids){
    const u=(await getDoc(doc(db,"usuarios",id))).data();
    const div=document.createElement("div");
    div.className="user";
    div.innerHTML=`<img src="${u.foto}"><b>${u.nick}</b>`;
    div.onclick=()=>abrirChat(id,u.nick);
    matches.appendChild(div);
  }
}

/* CHAT */
function abrirChat(id,nick){
  chatCon=id;
  chatTitle.innerText=nick;
  abrir("chat");
  mensajes.innerHTML="";
  const chatId=[auth.currentUser.uid,id].sort().join("_");
  onSnapshot(query(collection(db,"chats",chatId,"msgs"),orderBy("t")),snap=>{
    mensajes.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.u===auth.currentUser.uid?"me":"other");
      div.innerText=m.txt;
      mensajes.appendChild(div);
    });
    mensajes.scrollTop=mensajes.scrollHeight;
  });
}
window.enviar=async()=>{
  if(!texto.value) return;
  const chatId=[auth.currentUser.uid,chatCon].sort().join("_");
  await addDoc(collection(db,"chats",chatId,"msgs"),{
    u:auth.currentUser.uid,txt:texto.value,t:Date.now()
  });
  texto.value="";
};

/* NAV */
window.abrir=id=>{
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn-"+id).classList.add("active");
};
</script>
</head>

<body>

<div id="login">
  <h2>CHAT</h2>
  <button onclick="loginGoogle()">Entrar con Google</button>
</div>

<div id="app" id="appDiv">

<header id="chatTitle">DESCUBRIR</header>

<section id="descubrir">
  <div class="card">
    <img id="foto">
    <div class="info"><h2 id="nombre"></h2></div>
    <div class="actions">
      <button class="nope" onclick="dislike()">‚ùå</button>
      <button class="like" onclick="like()">‚ù§Ô∏è</button>
    </div>
  </div>
</section>

<section id="chat">
  <div id="mensajes"></div>
  <div id="chatInput">
    <input id="texto" placeholder="Mensaje">
    <button onclick="enviar()">Enviar</button>
  </div>
</section>

<section id="perfil"><div class="list">Perfil (hecho antes)</div></section>
<section id="config"><div class="list">Config</div></section>

<nav>
  <button id="btn-descubrir" class="active" onclick="abrir('descubrir')">Descubrir</button>
  <button id="btn-chat" onclick="abrir('chat')">Chat</button>
  <button id="btn-perfil" onclick="abrir('perfil')">Perfil</button>
  <button id="btn-config" onclick="abrir('config')">Config</button>
</nav>

<section id="chatList">
  <div id="matches" class="list"></div>
</section>

</div>

</body>
</html>
