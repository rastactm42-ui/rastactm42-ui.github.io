<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CHAT</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0b0b0b;
  color:#fff;
}
.container{
  max-width:420px;
  margin:30px auto;
  background:#111;
  padding:20px;
  border-radius:14px;
  box-shadow:0 0 20px #ff0066;
}
h2{text-align:center;color:#ff0066}

input,select,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border:none;
  border-radius:8px;
}
input,select{
  background:#000;
  color:#fff;
  border:1px solid #333;
}
button{
  background:#ff0066;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}

#app,#chat,#perfil{display:none}

.perfil{
  padding:10px;
  border-bottom:1px solid #333;
  cursor:pointer;
}
.perfil:hover{background:#222}

#mensajes{
  height:220px;
  overflow-y:auto;
  border:1px solid #333;
  padding:10px;
  margin-bottom:8px;
}
.msg{margin-bottom:6px}
.yo{color:#4da6ff}
.otro{color:#ff66cc}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="login">
  <h2>ðŸ’¬ CHAT</h2>
  <button onclick="loginGoogle()">ðŸ”µ Entrar con Google</button>
  <button onclick="loginFacebook()">ðŸ”· Entrar con Facebook</button>
</div>

<!-- PERFIL -->
<div class="container" id="perfil">
  <h2>Tu perfil</h2>
  <input id="nick" placeholder="Elige tu nick">
  <select id="tipo">
    <option value="">Selecciona</option>
    <option value="hombre">ðŸ‘¨ Hombre</option>
    <option value="mujer">ðŸ‘© Mujer</option>
  </select>
  <button onclick="guardarPerfil()">GUARDAR</button>
</div>

<!-- APP -->
<div class="container" id="app">
  <h2>Usuarios en CHAT</h2>
  <div id="perfiles"></div>
  <button onclick="salir()">SALIR</button>
</div>

<!-- CHAT PRIVADO -->
<div class="container" id="chat">
  <h2 id="chatCon"></h2>
  <div id="mensajes"></div>
  <input id="texto" placeholder="Mensaje">
  <button onclick="enviar()">ENVIAR</button>
  <button onclick="volver()">VOLVER</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyBszwdqJLY0GiPNlxh37_wNpSsIm0y9N0c",
  authDomain:"chat-1adf8.firebaseapp.com",
  projectId:"chat-1adf8"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();

const login=document.getElementById("login");
const perfil=document.getElementById("perfil");
const app=document.getElementById("app");
const chat=document.getElementById("chat");

const perfiles=document.getElementById("perfiles");
const mensajes=document.getElementById("mensajes");
const texto=document.getElementById("texto");
const chatCon=document.getElementById("chatCon");

const nickEl=document.getElementById("nick");
const tipoEl=document.getElementById("tipo");

let yo=null;
let miNick="";
let chatId="";

/* GOOGLE */
function loginGoogle(){
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
}

/* FACEBOOK */
function loginFacebook(){
  const provider=new firebase.auth.FacebookAuthProvider();
  auth.signInWithPopup(provider);
}

/* SESIÃ“N */
auth.onAuthStateChanged(u=>{
  if(!u)return;
  yo=u;
  login.style.display="none";

  db.collection("usuarios").doc(u.uid).get().then(doc=>{
    if(!doc.exists){
      perfil.style.display="block";
    }else{
      miNick=doc.data().nick;
      app.style.display="block";
      cargarPerfiles();
    }
  });
});

/* GUARDAR PERFIL */
function guardarPerfil(){
  if(!nickEl.value||!tipoEl.value)
    return alert("Completa tu perfil");

  db.collection("usuarios").doc(yo.uid).set({
    nick:nickEl.value,
    tipo:tipoEl.value
  }).then(()=>{
    miNick=nickEl.value;
    perfil.style.display="none";
    app.style.display="block";
    cargarPerfiles();
  });
}

/* LISTA DE USUARIOS */
function cargarPerfiles(){
  db.collection("usuarios").onSnapshot(s=>{
    perfiles.innerHTML="";
    s.forEach(d=>{
      if(d.id===yo.uid)return;
      const div=document.createElement("div");
      div.className="perfil";
      div.textContent=d.data().nick+" ("+d.data().tipo+")";
      div.onclick=()=>abrirChat(d.id,d.data().nick);
      perfiles.appendChild(div);
    });
  });
}

/* CHAT */
function abrirChat(uid,nick){
  chatId=[yo.uid,uid].sort().join("_");
  chatCon.innerText="Chat con "+nick;
  app.style.display="none";
  chat.style.display="block";

  db.collection("chats").doc(chatId)
  .collection("mensajes")
  .orderBy("time")
  .onSnapshot(s=>{
    mensajes.innerHTML="";
    s.forEach(m=>{
      const d=m.data();
      const div=document.createElement("div");
      div.className="msg "+(d.user===miNick?"yo":"otro");
      div.textContent=d.user+": "+d.texto;
      mensajes.appendChild(div);
    });
  });
}

function enviar(){
  if(!texto.value)return;
  db.collection("chats").doc(chatId)
  .collection("mensajes")
  .add({
    user:miNick,
    texto:texto.value,
    time:Date.now()
  });
  texto.value="";
}

function volver(){
  chat.style.display="none";
  app.style.display="block";
}

function salir(){
  auth.signOut();
  location.reload();
}
</script>

</body>
</html>

