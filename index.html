<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CHAT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#000,#1a0033,#000);
  color:#fff;
}
.container{
  max-width:420px;
  margin:30px auto;
  background:rgba(0,0,0,.9);
  padding:18px;
  border-radius:16px;
  box-shadow:0 0 25px #ff00ff;
}
h2{text-align:center;color:#ff00ff}
button,input,select{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:8px;
}
button{
  background:linear-gradient(90deg,#ff00ff,#ff0066);
  color:#fff;
  font-weight:bold;
}
input,select{
  background:#111;
  color:#fff;
  border:1px solid #333;
}
#chat,#privado,#setup{display:none}
#mensajes,#mensajesPriv{
  height:220px;
  overflow-y:auto;
  background:#000;
  border:1px solid #333;
  padding:8px;
  margin-bottom:8px;
}
.msg{margin-bottom:6px}
.userItem{
  padding:6px;
  border-bottom:1px solid #333;
  cursor:pointer;
}
.userItem:hover{background:#222}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getAuth, GoogleAuthProvider, signInWithPopup,
  onAuthStateChanged, signOut, updateProfile
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, query, orderBy, onSnapshot,
  serverTimestamp, increment
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyBszwdqJLY0GiPNlxh37_wNpSsIm0y9N0c",
  authDomain: "chat-1adf8.firebaseapp.com",
  projectId: "chat-1adf8",
  storageBucket: "chat-1adf8.firebasestorage.app",
  messagingSenderId: "466107819820",
  appId: "1:466107819820:web:e297a7c513db3d96696e89"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let userData=null;
let privadoCon=null;

/* LOGIN */
window.loginGoogle = ()=>signInWithPopup(auth,provider);

/* SESIÃ“N */
onAuthStateChanged(auth, async(user)=>{
  if(!user) return;
  const ref=doc(db,"usuarios",user.uid);
  const snap=await getDoc(ref);

  if(!snap.exists()){
    login.style.display="none";
    setup.style.display="block";
  }else{
    userData=snap.data();
    entrar();
  }
});

/* PERFIL */
window.guardarPerfil = async()=>{
  const nick=nickInput.value;
  const genero=generoSelect.value;
  if(!nick||!genero) return alert("Completa todo");

  await setDoc(doc(db,"usuarios",auth.currentUser.uid),{
    uid:auth.currentUser.uid,
    nick,genero,
    monedas: genero==="hombre"?500:0
  });
  await updateProfile(auth.currentUser,{displayName:nick});
  location.reload();
};

/* ENTRAR */
function entrar(){
  login.style.display="none";
  setup.style.display="none";
  chat.style.display="block";
  usuario.innerText=userData.nick;
  monedasEl.innerText=userData.monedas;
  chatGeneral();
  listarUsuarios();
}

/* CHAT GENERAL */
function chatGeneral(){
  const q=query(collection(db,"chat"),orderBy("time"));
  onSnapshot(q,s=>{
    mensajes.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg";
      div.style.color=m.tipo==="regalo"?"#FFD700":
        m.genero==="mujer"?"#ff4fd8":"#4fc3ff";
      div.innerText=m.nick+": "+m.texto;
      mensajes.appendChild(div);
    });
  });
}

window.enviarMensaje=async()=>{
  if(!texto.value) return;
  await addDoc(collection(db,"chat"),{
    nick:userData.nick,
    genero:userData.genero,
    texto:texto.value,
    tipo:"texto",
    time:serverTimestamp()
  });
  texto.value="";
};

/* LISTA USUARIOS */
function listarUsuarios(){
  onSnapshot(collection(db,"usuarios"),s=>{
    lista.innerHTML="";
    s.forEach(d=>{
      if(d.id===auth.currentUser.uid) return;
      const u=d.data();
      const div=document.createElement("div");
      div.className="userItem";
      div.innerText=u.nick+" ("+u.genero+")";
      div.onclick=()=>abrirPrivado(u);
      lista.appendChild(div);
    });
  });
}

/* CHAT PRIVADO */
function abrirPrivado(u){
  privadoCon=u;
  chat.style.display="none";
  privado.style.display="block";
  privadoNick.innerText=u.nick;
  escucharPrivado();
}

function escucharPrivado(){
  const id=[auth.currentUser.uid,privadoCon.uid].sort().join("_");
  const q=query(collection(db,"privados",id,"msgs"),orderBy("time"));
  onSnapshot(q,s=>{
    mensajesPriv.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.innerText=m.nick+": "+m.texto;
      mensajesPriv.appendChild(div);
    });
  });
}

window.enviarPrivado=async()=>{
  if(userData.monedas<20) return alert("No tienes monedas");
  const id=[auth.currentUser.uid,privadoCon.uid].sort().join("_");

  await updateDoc(doc(db,"usuarios",auth.currentUser.uid),{
    monedas:increment(-20)
  });

  await addDoc(collection(db,"privados",id,"msgs"),{
    nick:userData.nick,
    texto:textoPriv.value,
    time:serverTimestamp()
  });

  userData.monedas-=20;
  monedasEl.innerText=userData.monedas;
  textoPriv.value="";
};

window.volver=()=>{
  privado.style.display="none";
  chat.style.display="block";
};

/* REGALO */
window.enviarRegalo=async(n,p)=>{
  if(userData.monedas<p) return;
  await updateDoc(doc(db,"usuarios",auth.currentUser.uid),{
    monedas:increment(-p)
  });
  await addDoc(collection(db,"chat"),{
    nick:userData.nick,
    texto:`ðŸŽ ${n} (${p})`,
    tipo:"regalo",
    time:serverTimestamp()
  });
  userData.monedas-=p;
  monedasEl.innerText=userData.monedas;
};

window.salir=async()=>{await signOut(auth);location.reload();}
</script>
</head>

<body>

<div class="container" id="login">
  <h2>CHAT</h2>
  <button onclick="loginGoogle()">Entrar con Google</button>
</div>

<div class="container" id="setup">
  <h2>Perfil</h2>
  <input id="nickInput" placeholder="Nick">
  <select id="generoSelect">
    <option value="">GÃ©nero</option>
    <option value="hombre">Hombre</option>
    <option value="mujer">Mujer</option>
  </select>
  <button onclick="guardarPerfil()">Guardar</button>
</div>

<div class="container" id="chat">
  ðŸ‘¤ <span id="usuario"></span><br>
  ðŸ’° <span id="monedasEl"></span> monedas
  <div id="mensajes"></div>
  <input id="texto" placeholder="Mensaje gratis">
  <button onclick="enviarMensaje()">Enviar</button>

  <button onclick="enviarRegalo('Rosa',50)">ðŸŒ¹ 50</button>

  <h3>Usuarios</h3>
  <div id="lista"></div>

  <button onclick="salir()">Salir</button>
</div>

<div class="container" id="privado">
  <h2>Chat privado con <span id="privadoNick"></span></h2>
  <p>Costo: 20 monedas por mensaje</p>
  <div id="mensajesPriv"></div>
  <input id="textoPriv" placeholder="Mensaje privado">
  <button onclick="enviarPrivado()">Enviar (20)</button>
  <button onclick="volver()">Volver</button>
</div>

</body>
</html>
