<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CHAT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:Arial, sans-serif;
  background:#000;
  color:#fff;
  height:100vh;
  overflow:hidden;
}
#app{display:flex;flex-direction:column;height:100vh}
main{flex:1;overflow:hidden}

/* NAV */
nav{
  height:60px;
  display:flex;
  background:#111;
  border-top:1px solid #333;
}
nav button{
  flex:1;
  background:none;
  border:none;
  color:#aaa;
  font-size:12px;
}
nav button.active{color:#ff3366}

/* SECCIONES */
section{display:none;height:100%}
section.active{display:block}

/* DESCUBRIR */
.card{
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  background-size:cover;
  background-position:center;
}
.info{
  background:linear-gradient(transparent,rgba(0,0,0,.9));
  padding:20px;
}
.info h2{font-size:26px}

/* CHAT */
#chatBox{
  height:70vh;
  overflow:auto;
  padding:10px;
}
.msg{
  background:#222;
  padding:8px;
  border-radius:8px;
  margin-bottom:6px;
}
textarea{
  width:100%;
  padding:10px;
  border:none;
  background:#111;
  color:#fff;
}
button.principal{
  width:100%;
  padding:12px;
  background:#ff3366;
  border:none;
  color:#fff;
  font-weight:bold;
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  collection,
  addDoc,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBszwdqJLY0GiPNlxh37_wNpSsIm0y9N0c",
  authDomain: "chat-1adf8.firebaseapp.com",
  projectId: "chat-1adf8",
  storageBucket: "chat-1adf8.firebasestorage.app",
  messagingSenderId: "466107819820",
  appId: "1:466107819820:web:e297a7c513db3d96696e89"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let yo, datos;
const usersRef = collection(db,"users");
const chatRef = collection(db,"chat");

/* LOGIN */
window.login = ()=>signInWithPopup(auth,provider);

/* SESIÃ“N */
onAuthStateChanged(auth, async user=>{
  if(!user) return;
  yo=user;

  const ref=doc(db,"users",user.uid);
  const snap=await getDoc(ref);

  if(!snap.exists()){
    await setDoc(ref,{
      nombre:user.displayName,
      foto:user.photoURL,
      genero:"hombre",
      mensajes:0
    });
  }

  datos=(await getDoc(ref)).data();
  document.getElementById("login").style.display="none";
  document.getElementById("app").style.display="flex";
  mostrar("descubrir");
  cargarUsuarios();
  escucharChat();
});

/* DESCUBRIR */
function cargarUsuarios(){
  onSnapshot(usersRef,snap=>{
    snap.forEach(d=>{
      const u=d.data();
      if(d.id!==yo.uid){
        descubrir.innerHTML=`
          <div class="card" style="background-image:url('${u.foto}')">
            <div class="info">
              <h2>${u.nombre}</h2>
            </div>
          </div>
        `;
      }
    });
  });
}

/* CHAT */
window.enviar = async()=>{
  if(datos.genero==="hombre" && datos.mensajes>=30){
    alert("LÃ­mite de 30 mensajes alcanzado");
    return;
  }
  if(!mensaje.value) return;

  await addDoc(chatRef,{
    nombre:datos.nombre,
    texto:mensaje.value,
    fecha:Date.now()
  });

  if(datos.genero==="hombre"){
    datos.mensajes++;
    await updateDoc(doc(db,"users",yo.uid),{
      mensajes:datos.mensajes
    });
  }
  mensaje.value="";
};

function escucharChat(){
  onSnapshot(chatRef,snap=>{
    chatBox.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      chatBox.innerHTML+=`
        <div class="msg"><b>${m.nombre}:</b> ${m.texto}</div>
      `;
    });
  });
}

/* NAV */
window.mostrar=id=>{
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById("b_"+id).classList.add("active");
};
</script>
</head>

<body>

<div id="login" style="height:100vh;display:flex;align-items:center;justify-content:center">
  <button class="principal" onclick="login()">Entrar con Google</button>
</div>

<div id="app" style="display:none">

<main>
<section id="descubrir" class="active"></section>

<section id="chat">
  <div id="chatBox"></div>
  <textarea id="mensaje" placeholder="Mensaje"></textarea>
  <button class="principal" onclick="enviar()">Enviar</button>
</section>

<section id="perfil">
  <h2 style="padding:20px">Perfil</h2>
</section>
</main>

<nav>
  <button id="b_descubrir" class="active" onclick="mostrar('descubrir')">ðŸ”¥</button>
  <button id="b_chat" onclick="mostrar('chat')">ðŸ’¬</button>
  <button id="b_perfil" onclick="mostrar('perfil')">ðŸ‘¤</button>
</nav>

</div>

</body>
</html>
